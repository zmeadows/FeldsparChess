#define _HAS_EXCEPTIONS 0
#include "gtest/gtest.h"

import prelude;
import bitboard;
// #include <vector>
TEST(Bitboard, StringToBitboardConversion)
{
    EXPECT_EQ(BITBOARD_EMPTY, BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"));

    EXPECT_EQ(BITBOARD_FULL, BB("11111111"
                                "11111111"
                                "11111111"
                                "11111111"
                                "11111111"
                                "11111111"
                                "11111111"
                                "11111111"));

    EXPECT_EQ(square_bitrep(0), BB("00000000"
                                   "00000000"
                                   "00000000"
                                   "00000000"
                                   "00000000"
                                   "00000000"
                                   "00000000"
                                   "00000001"));

    EXPECT_EQ(square_bitrep(63), BB("10000000"
                                    "00000000"
                                    "00000000"
                                    "00000000"
                                    "00000000"
                                    "00000000"
                                    "00000000"
                                    "00000000"));

    EXPECT_EQ(0b1001011110010111100101111001011110010111100101111001011110010111, BB("10010111"
                                                                                     "10010111"
                                                                                     "10010111"
                                                                                     "10010111"
                                                                                     "10010111"
                                                                                     "10010111"
                                                                                     "10010111"
                                                                                     "10010111"));

    EXPECT_EQ(0b0100110000010101010001000010111011100000010010101001100011001001, BB("01001100"
                                                                                     "00010101"
                                                                                     "01000100"
                                                                                     "00101110"
                                                                                     "11100000"
                                                                                     "01001010"
                                                                                     "10011000"
                                                                                     "11001001"));
}

TEST(Bitboard, BitScanForward)
{

    EXPECT_EQ(0, bitboard_bsf(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000")));

    EXPECT_EQ(0, bitboard_bsf(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000001")));

    EXPECT_EQ(31, bitboard_bsf(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "10000000"
                                  "00000000"
                                  "00000000"
                                  "00000000")));

    EXPECT_EQ(7, bitboard_bsf(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "10000000")));

    EXPECT_EQ(7, bitboard_bsf(BB("10000000"
                                 "00010000"
                                 "01001110"
                                 "00000000"
                                 "01000000"
                                 "00001110"
                                 "00000000"
                                 "10000000")));

    EXPECT_EQ(63, bitboard_bsf(BB("10000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000")));
}

TEST(Bitboard, BitScanReverse)
{

    EXPECT_EQ(0, bitboard_bsr(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000")));

    EXPECT_EQ(0, bitboard_bsr(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000001")));

    EXPECT_EQ(31, bitboard_bsr(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "10000000"
                                  "00000000"
                                  "00000000"
                                  "00000000")));

    EXPECT_EQ(7, bitboard_bsr(BB("00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "00000000"
                                 "10000000")));

    EXPECT_EQ(63, bitboard_bsr(BB("10000000"
                                  "00010000"
                                  "01001110"
                                  "00000000"
                                  "01000000"
                                  "00001110"
                                  "00000000"
                                  "10000000")));

    EXPECT_EQ(63, bitboard_bsr(BB("10000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000")));
}

TEST(Bitboard, PopulationCount)
{

    EXPECT_EQ(1, bitboard_popcount(BB("10000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000")));

    EXPECT_EQ(0, bitboard_popcount(BB("00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000"
                                      "00000000")));

    EXPECT_EQ(8, bitboard_popcount(BB("00010000"
                                      "00010000"
                                      "00010000"
                                      "00010000"
                                      "00010000"
                                      "00010000"
                                      "00010000"
                                      "00010000")));

    EXPECT_EQ(64, bitboard_popcount(BB("11111111"
                                       "11111111"
                                       "11111111"
                                       "11111111"
                                       "11111111"
                                       "11111111"
                                       "11111111"
                                       "11111111")));

    EXPECT_EQ(54, bitboard_popcount(BB("11101111"
                                       "10111011"
                                       "11111111"
                                       "10101111"
                                       "11111101"
                                       "11111111"
                                       "11110111"
                                       "10101101")));

    EXPECT_EQ(44, bitboard_popcount(BB("11101001"
                                       "10111011"
                                       "11001111"
                                       "10101111"
                                       "11111101"
                                       "10010011"
                                       "10110111"
                                       "10101001")));
}

TEST(Bitboard, EmptyFullOccupiedChecks)
{
    EXPECT_TRUE(bitboard_is_full(BITBOARD_FULL));

    EXPECT_TRUE(bitboard_is_full(BB("11111111"
                                    "11111111"
                                    "11111111"
                                    "11111111"
                                    "11111111"
                                    "11111111"
                                    "11111111"
                                    "11111111")));

    EXPECT_TRUE(bitboard_is_empty(BITBOARD_EMPTY));

    EXPECT_TRUE(bitboard_is_empty(BB("00000000"
                                     "00000000"
                                     "00000000"
                                     "00000000"
                                     "00000000"
                                     "00000000"
                                     "00000000"
                                     "00000000")));

    EXPECT_TRUE(bitboard_is_occupied(BB("00000000"
                                        "00000000"
                                        "00000000"
                                        "00000000"
                                        "00100000"
                                        "00000000"
                                        "00000000"
                                        "00000000")));

    EXPECT_TRUE(bitboard_is_occupied(BITBOARD_FULL));
    EXPECT_TRUE(!bitboard_is_occupied(BITBOARD_EMPTY));
}

TEST(Bitboard, Shifts)
{
    EXPECT_EQ(BITBOARD_EMPTY, bitboard_shifted(BB("11111111"
                                                  "00000000"
                                                  "00000000"
                                                  "00000000"
                                                  "00000000"
                                                  "00000000"
                                                  "00000000"
                                                  "00000000"),
                                               Direction::North));

    EXPECT_EQ(bitboard_shifted(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111"),
                               Direction::North),
              BB("00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "11111111"
                 "00000000"));

    EXPECT_EQ(BB("00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "11111111"),
              bitboard_shifted(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111"
                                  "00000000"),
                               Direction::South));

    EXPECT_EQ(bitboard_shifted(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111"),
                               Direction::South),
              BITBOARD_EMPTY);

    EXPECT_EQ(bitboard_shifted(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111"),
                               Direction::NorthEast),
              BB("00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "01111111"
                 "00000000"));

    EXPECT_EQ(bitboard_shifted(BB("10000000"
                                  "01000000"
                                  "00100000"
                                  "00010000"
                                  "00001000"
                                  "00000100"
                                  "00000010"
                                  "00000001"),
                               Direction::NorthEast),
              BB("00100000"
                 "00010000"
                 "00001000"
                 "00000100"
                 "00000010"
                 "00000001"
                 "00000000"
                 "00000000"));

    EXPECT_EQ(bitboard_shifted(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111"),
                               Direction::NorthWest),
              BB("00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "00000000"
                 "11111110"
                 "00000000"));

    EXPECT_EQ(bitboard_shifted(BB("10000000"
                                  "01000000"
                                  "00100000"
                                  "00010000"
                                  "00001000"
                                  "00000100"
                                  "00000010"
                                  "00000001"),
                               Direction::NorthWest),
              BB("10000000"
                 "01000000"
                 "00100000"
                 "00010000"
                 "00001000"
                 "00000100"
                 "00000010"
                 "00000000"));
}

TEST(Bitboard, Flip)
{
    EXPECT_EQ(bitboard_flipped(BB("00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "00000000"
                                  "11111111")),
              BB("11111111"
                 "11111111"
                 "11111111"
                 "11111111"
                 "11111111"
                 "11111111"
                 "11111111"
                 "00000000"));

    EXPECT_EQ(bitboard_flipped(BB("11111111"
                                  "10000001"
                                  "10000001"
                                  "10011001"
                                  "10011001"
                                  "10000001"
                                  "10000001"
                                  "11111111")),
              BB("00000000"
                 "01111110"
                 "01111110"
                 "01100110"
                 "01100110"
                 "01111110"
                 "01111110"
                 "00000000"));

    EXPECT_EQ(bitboard_flipped(BITBOARD_EMPTY), BITBOARD_FULL);
    EXPECT_EQ(bitboard_flipped(BITBOARD_FULL), BITBOARD_EMPTY);
}

TEST(Bitboard, Serialization)
{
    {
        const Bitboard bb = BB("01100000"
                               "00010000"
                               "00010000"
                               "00001000"
                               "00000100"
                               "00000100"
                               "00000000"
                               "00000001");
        U64 count = 0;
        bitboard_iter_squares(bb, [&](Square sq) -> void { count++; });
        EXPECT_TRUE(count == 8);
    }

    {
        U64 count = 0;
        bitboard_iter_squares(BITBOARD_EMPTY, [&](Square sq) -> void { count++; });
        EXPECT_TRUE(count == 0);
    }

    // {
    //     const Bitboard bb = BB("10000000"
    //                            "01000000"
    //                            "00100000"
    //                            "00010000"
    //                            "00001000"
    //                            "00000100"
    //                            "00000010"
    //                            "00000001");
    //     std::vector<Square> squares;
    //     bitboard_iter_squares(bb, [&](Square sq) -> void { squares.push_back(sq); });
    //     EXPECT_EQ(squares, std::vector<Square>({0, 9, 18, 27, 36, 45, 54, 63}));
    // }
}
